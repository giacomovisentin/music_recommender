<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Music Recommender</title>
  <style>
    body {
      font-family: Inter, sans-serif;
      background: #0d1117;
      color: #f0f6fc;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px 16px;
    }
    .container {
      width: 900px;
      max-width: 100%;
    }
    h1 {
      text-align: center;
      color: #58a6ff;
      margin-bottom: 20px;
    }
    .search-box {
      position: relative;
      margin-bottom: 20px;
    }
    input {
      width: 100%;
      padding: 14px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #30363d;
      background: #161b22;
      color: #f0f6fc;
      outline: none;
    }
    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 4px;
      z-index: 10;
    }
    .suggestion {
      padding: 10px 14px;
      cursor: pointer;
      border-bottom: 1px solid #21262d;
    }
    .suggestion:hover, .suggestion.active {
      background: #238636;
    }
    .results {
      margin-top: 30px;
    }
    .selected {
      background: #238636;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 20px;
    }
    .recommendation {
      background: #161b22;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid #30363d;
    }
    .meta {
      color: #8b949e;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Music Recommender</h1>
    <div class="search-box">
      <input id="search" type="text" placeholder="Cerca una canzone o un artista...">
      <div id="suggestions" class="suggestions" style="display:none;"></div>
    </div>

    <div id="selected-song" class="selected" style="display:none;"></div>

    <div id="recommendations" class="results"></div>
  </div>

  <script>
    const search = document.getElementById('search');
    const suggestionsBox = document.getElementById('suggestions');
    const recsDiv = document.getElementById('recommendations');
    const selectedDiv = document.getElementById('selected-song');
    let currentSuggestions = [];

    async function fetchSuggestions(q) {
      const res = await fetch(`/suggest?q=${encodeURIComponent(q)}`);
      return res.ok ? res.json() : [];
    }

    async function fetchRecommendations(index) {
      const res = await fetch('/recommend', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({index})
      });
      return res.ok ? res.json() : null;
    }

    search.addEventListener('input', async () => {
      const q = search.value.trim();
      if (q.length < 2) {
        suggestionsBox.style.display = 'none';
        return;
      }
      const data = await fetchSuggestions(q);
      currentSuggestions = data;
      renderSuggestions(data);
    });

    function renderSuggestions(list) {
      suggestionsBox.innerHTML = '';
      if (list.length === 0) {
        suggestionsBox.style.display = 'none';
        return;
      }
      list.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = 'suggestion';
        div.innerHTML = `<strong>${item.track_name}</strong><br><span class="meta">${item.artist_name}</span>`;
        div.addEventListener('click', () => handleSelection(item, div));
        suggestionsBox.appendChild(div);
      });
      suggestionsBox.style.display = 'block';
    }

    async function handleSelection(item, element) {
      suggestionsBox.style.display = 'none';
      search.value = `${item.track_name} - ${item.artist_name}`;
      document.querySelectorAll('.suggestion').forEach(el => el.classList.remove('active'));
      element?.classList.add('active');

      const data = await fetchRecommendations(item.index);
      if (!data || data.status !== 'success') return;

      selectedDiv.style.display = 'block';
      selectedDiv.innerHTML = `<h3>${data.selected.track_name}</h3><div class="meta">${data.selected.artist_name}</div>`;

      recsDiv.innerHTML = '';
      data.recommendations.forEach(rec => {
        const div = document.createElement('div');
        div.className = 'recommendation';
        div.innerHTML = `<strong>${rec.track_name}</strong><div class="meta">${rec.artist_name}<br>${rec.genres} • Similarità ${(rec.similarity*100).toFixed(1)}%</div>`;
        recsDiv.appendChild(div);
      });
    }

    // Chiude suggerimenti cliccando fuori
    document.addEventListener('click', (e)=>{
      if (!suggestionsBox.contains(e.target) && e.target !== search) {
        suggestionsBox.style.display = 'none';
      }
    });
  </script>
</body>
</html>
